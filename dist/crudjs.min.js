function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _construct(e,t,n){return(_construct=_isNativeReflectConstruct()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var a=new(Function.bind.apply(e,r));return n&&_setPrototypeOf(a,n.prototype),a}).apply(null,arguments)}function _isNativeFunction(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function _wrapNativeSuper(e){var n="function"==typeof Map?new Map:void 0;return(_wrapNativeSuper=function(e){if(null===e||!_isNativeFunction(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(e))return n.get(e);n.set(e,t)}function t(){return _construct(e,arguments,_getPrototypeOf(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(t,e)})(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function _createSuper(r){return function(){var e,t=_getPrototypeOf(r);if(_isNativeReflectConstruct()){var n=_getPrototypeOf(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return _possibleConstructorReturn(this,e)}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _createForOfIteratorHelper(e){if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=_unsupportedIterableToArray(e))){function t(){}var n=0;return{s:t,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a,s=!0,i=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){i=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(i)throw a}}}}function createElement(e){var t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild}function resetElementHTML(e){e.innerHTML=""}function isHidden(e){return"none"===e.style.display}var LANGUAGES={en:{basic:{yes:"Yes",no:"No",ok:"OK",cancel:"Cancel",error:"Error",warning:"Warning"},component:{configurationError:"Incorrect configuration. Please read the README of the project to correct your configuration.",urlError:"An error occured while trying to fetch resource. See:"},request:{badResponse:"Bad response",okResponse:"Saving done",addImpossible:"Could not add the line:",modifyImpossible:"Could not modify the line:",deleteImpossible:"Could not delete the line:"},table:{column:{actionName:"Action(s)"},modal:{delete:{title:"Warning!",message:"Are you sure you want to delete this line?"}}},line:{btn:{edit:"Edit",delete:"Delete",validate:"Validate",cancel:"Cancel",add:"Add",addCancel:"Reset"},messages:{invalidColumn:"Invalid column:"}},field:{selectChips:{select:"Select..."}}},fr:{basic:{yes:"Oui",no:"Non",ok:"OK",cancel:"Annuler",error:"Erreur",warning:"Attention"},component:{configurationError:"Configuration incorrect. Veuillez lire le README du projet pour corriger votre configuration.",urlError:"Une erreur est survenue en essayant d'atteindre la resource. Voyez:"},request:{badResponse:"Mauvaise réponse",okResponse:"Sauvegarde effectuée",addImpossible:"Impossible d'ajouter la ligne :",modifyImpossible:"Impossible de modifier la ligne :",deleteImpossible:"Impossible de supprimer la ligne :"},table:{column:{actionName:"Action(s)"},modal:{delete:{title:"Attention!",message:"Voulez-vous vraiment supprimer cette ligne ?"}}},line:{btn:{edit:"Editer",delete:"Supprimer",validate:"Valider",cancel:"Annuler",add:"Ajouter",addCancel:"Réinitialiser"},messages:{invalidColumn:"Colonne invalide :"}},field:{selectChips:{select:"Sélectionner..."}}}},DEFAULT_LANG="en";function langExist(e){return null!=e&&null!=LANGUAGES[e]}function _text(e,t){if(langExist(e)){var n=t.split(".");if(null!=t&&t.length<1)throw new Error("Invalid text request.");var r,a=LANGUAGES[e],s=_createForOfIteratorHelper(n);try{for(s.s();!(r=s.n()).done;){if(null==(a=a[r.value]))throw new Error("Invalid text request.")}}catch(e){s.e(e)}finally{s.f()}return a}throw new Error("Language not found")}var FIELD_STATE=Object.freeze({VIEW:1,EDIT:2}),CrudField=function(){function r(e,t,n){if(_classCallCheck(this,r),(this instanceof r?this.constructor:void 0)===r)throw new TypeError("Cannot construct CrudField instances directly");this._value=e,this._columnDesc=t,this._crud=n,this._state=FIELD_STATE.VIEW,this._element=r.createElement()}return _createClass(r,null,[{key:"createElement",value:function(){return document.createElement("td")}}]),_createClass(r,[{key:"update",value:function(){switch(resetElementHTML(this.element),this.state){case FIELD_STATE.VIEW:this._buildDisplayView();break;case FIELD_STATE.EDIT:this._buildEditView()}}},{key:"showDisplayView",value:function(){this.state=FIELD_STATE.VIEW,this.update()}},{key:"showEditView",value:function(){this.state=FIELD_STATE.EDIT,this.update()}},{key:"validate",value:function(){return this.value=this.newValue,this.value}},{key:"_buildDisplayView",value:function(){throw new Error("Method not implemented")}},{key:"_buildEditView",value:function(){throw new Error("Method not implemented")}},{key:"isValid",value:function(){throw new Error("Method not implemented")}},{key:"element",get:function(){return this._element}},{key:"columnDesc",get:function(){return this._columnDesc}},{key:"crud",get:function(){return this._crud}},{key:"state",get:function(){return this._state},set:function(e){this._state=e}},{key:"value",get:function(){return null==this._value?this.defaultValue:this._value},set:function(e){this._value=e}},{key:"edit",get:function(){return this.state===FIELD_STATE.EDIT}},{key:"defaultValue",get:function(){throw new Error("Method not implemented")}},{key:"newValue",get:function(){throw new Error("Method not implemented")}}]),r}(),CrudFieldDecorator=function(){_inherits(r,CrudField);var n=_createSuper(r);function r(e){var t;return _classCallCheck(this,r),(t=n.call(this)).__customCrudField=e,t}return _createClass(r,[{key:"_buildDisplayView",value:function(){this.__customCrudField.buildDisplayView()}},{key:"_buildEditView",value:function(){this.__customCrudField.buildEditView()}},{key:"isValid",value:function(){return this.__customCrudField.isValid()}},{key:"element",get:function(){return this.__customCrudField.element}},{key:"columnDesc",get:function(){return this.__customCrudField.columnDesc}},{key:"value",get:function(){return null==this.__customCrudField.value?this.__customCrudField.getDefaultValue():this.__customCrudField.value},set:function(e){this.__customCrudField.value=e}},{key:"defaultValue",get:function(){return this.__customCrudField.getDefaultValue()}},{key:"newValue",get:function(){return this.edit?this.__customCrudField.getNewValue():this.value}}]),r}(),CrudFieldFactory=function(){function CrudFieldFactory(){if(_classCallCheck(this,CrudFieldFactory),this.__cls={},this.__customCls={},"undefined"!=typeof CUSTOM_FIELDS&&null!==CUSTOM_FIELDS)for(var e in CUSTOM_FIELDS)CUSTOM_FIELDS.hasOwnProperty(e)&&(this.__customCls[e]=CUSTOM_FIELDS[e])}return _createClass(CrudFieldFactory,null,[{key:"getInstance",value:function(){return this._instance||(this._instance=new this),this._instance}}]),_createClass(CrudFieldFactory,[{key:"__getClassName",value:function(e){for(var t=e.split("-"),n=0;n<t.length;n++)t[n]=t[n].charAt(0).toUpperCase()+t[n].slice(1);return t.join("")+"CrudField"}},{key:"__getClass",value:function __getClass(name){var className=this.__getClassName(name);if(!this.__cls[name]){if(!className.match(/^[a-zA-Z0-9_]+$/))throw new Error("Unexpected name: ".concat(className));try{this.__cls[name]=eval(className)}catch(e){if("ReferenceError"===e.name)return;console.log(e)}}return this.__cls[name]}},{key:"create",value:function(e,t,n,r){if(this.__customCls[e]){var a=this.__customCls[e];return new CrudFieldDecorator(new a(t,n,r))}var s=this.__getClass(e);return null==s?s:new s(t,n,r)}}]),CrudFieldFactory}(),CrudEditLine=function(){function s(e,t){_classCallCheck(this,s),this.values=e,this.crudTable=t,this.element=document.createElement("tr"),this.element.className="crudjs-edit-line",this.fields=[];for(var n=this.crudTable.crud.getData().columns,r=CrudFieldFactory.getInstance(),a=0;a<this.values.length;a++)this.fields.push(r.create(n[a].type,this.values[a],n[a],this.crudTable.crud));this.showDisplayView()}return _createClass(s,[{key:"showDisplayView",value:function(){resetElementHTML(this.element),this.addNumberColumn();var e,t=_createForOfIteratorHelper(this.fields);try{for(t.s();!(e=t.n()).done;){var n=e.value;n.showDisplayView(),this.addColumn(n.element)}}catch(e){t.e(e)}finally{t.f()}this.crudTable.crud.isEditable()&&this.addActionsColumn(),this.crudTable.enableButtons()}},{key:"showEditView",value:function(){if(this.crudTable.crud.isEditable()){resetElementHTML(this.element),this.addNumberColumn();var e,t=_createForOfIteratorHelper(this.fields);try{for(t.s();!(e=t.n()).done;){var n=e.value;n.showEditView(),this.addColumn(n.element)}}catch(e){t.e(e)}finally{t.f()}this.addEditActionsColumn(),this.crudTable.disableButtons()}}},{key:"getStatus",value:function(){return this.values.status}},{key:"setStatus",value:function(e){this.values.status=e}},{key:"getElement",value:function(){return this.element}},{key:"getValues",value:function(){return this.values}},{key:"addColumn",value:function(e){this.element.appendChild(e)}},{key:"addNumberColumn",value:function(){var e=document.createElement("th");e.className="crudjs-line-number text-center",e.setAttribute("scope","row"),this.element.appendChild(e)}},{key:"addActionsColumn",value:function(){var e=this.crudTable.crud,t=this,n=document.createElement("td");n.className="text-right",n.innerHTML='\n            <button type="button" style="width:45px;" class="crudjs-edit-btn btn btn-raised btn-info mb-1 rounded" title="'.concat(e.text("line.btn.edit"),'"><i class="fas fa-pencil-alt"></i></button>\n            <button type="button" style="width:45px;" class="crudjs-delete-btn btn btn-raised btn-danger mb-1 rounded" data-toggle="modal" data-target="#')+this.crudTable.modalDeleteId+'" title="'.concat(e.text("line.btn.delete"),'"><i class="fas fa-trash"></i></button>\n        '),n.getElementsByClassName("crudjs-edit-btn")[0].onclick=function(){t.showEditView(),t.crudTable.updateLineNumbers()},n.getElementsByClassName("crudjs-delete-btn")[0].onclick=function(){t.crudTable.getModalDelete().getElementsByClassName("crudjs-modal-valid")[0].onclick=function(){if("N"!==t.getStatus())t.setStatus("D"),t.element.style.display="none";else{t.element.remove();var e=t.crudTable.crud.getData().values;e.splice(e.indexOf(t.values),1)}t.crudTable.updateLineNumbers()}},this.element.appendChild(n)}},{key:"addEditActionsColumn",value:function(){var i=this.crudTable.crud,l=this,e=document.createElement("td");e.className="text-right",e.innerHTML='\n            <button type="button" style="width:45px;" class="crudjs-validate-btn btn btn-raised btn-success mb-1 rounded" title="'.concat(i.text("line.btn.validate"),'"><i class="fas fa-sm fa-check"></i></button>\n            <button type="button" style="width:45px;" class="crudjs-cancel-btn btn btn-raised btn-danger mb-1 rounded" title="').concat(i.text("line.btn.cancel"),'"><i class="fas fa-times"></i></button>\n        '),e.getElementsByClassName("crudjs-validate-btn")[0].onclick=function(){for(var e=[],t=0;t<l.values.length;t++)l.fields[t].isValid()||e.push("".concat(i.text("line.messages.invalidColumn")," '").concat(l.fields[t].columnDesc.name,"'"));if(null!=e&&0<e.length){var n,r=_createForOfIteratorHelper(e);try{for(r.s();!(n=r.n()).done;){var a=n.value;i.addMessage("warning",i.text("basic.warning"),a,15e3)}}catch(e){r.e(e)}finally{r.f()}}else{for(var s=0;s<l.values.length;s++)l.values[s]=l.fields[s].validate();"S"===l.getStatus()&&l.setStatus("M"),l.showDisplayView(),l.crudTable.updateLineNumbers()}},e.getElementsByClassName("crudjs-cancel-btn")[0].onclick=function(){l.showDisplayView(),l.crudTable.updateLineNumbers()},this.element.appendChild(e)}}]),s}(),CrudAddLine=function(){function a(e){_classCallCheck(this,a),this.crudTable=e,this.element=document.createElement("tr"),this.element.className="crudjs-add-line";var t=this.crudTable.crud.getData().columns;this.initData(t.length),this.fields=[];for(var n=CrudFieldFactory.getInstance(),r=0;r<this.values.length;r++)this.fields.push(n.create(t[r].type,this.values[r],t[r],this.crudTable.crud));this.show()}return _createClass(a,[{key:"initData",value:function(e){this.values=new Array(e),this.values.status="N",this.values.oldValue=_toConsumableArray(this.values)}},{key:"show",value:function(){resetElementHTML(this.element),this.addEmptyColumn();var e,t=_createForOfIteratorHelper(this.fields);try{for(t.s();!(e=t.n()).done;){var n=e.value;n.showEditView(),this.addColumn(n.element)}}catch(e){t.e(e)}finally{t.f()}this.crudTable.crud.isEditable()&&this.addActionsColumn(),this.crudTable.enableButtons()}},{key:"getElement",value:function(){return this.element}},{key:"getValues",value:function(){return this.values}},{key:"addColumn",value:function(e){this.element.appendChild(e)}},{key:"addEmptyColumn",value:function(){var e=document.createElement("th");e.setAttribute("scope","row"),this.element.appendChild(e)}},{key:"addActionsColumn",value:function(){var o=this.crudTable.crud,u=this,e=document.createElement("td");e.className="text-right",e.innerHTML='\n            <button type="button" style="width:45px;" class="crudjs-add-btn btn btn-raised btn-secondary mb-1 rounded" title="'.concat(o.text("line.btn.add"),'"><i class="fas fa-plus"></i></button>\n            <button type="button" style="width:45px;" class="crudjs-add-cancel-btn btn btn-raised btn-danger mb-1 rounded" title="').concat(o.text("line.btn.addCancel"),'"><i class="fas fa-times"></i></button>\n        '),e.getElementsByClassName("crudjs-add-btn")[0].onclick=function(){for(var e=[],t=0;t<u.values.length;t++)u.fields[t].isValid()||e.push("".concat(o.text("line.messages.invalidColumn")," '").concat(u.fields[t].columnDesc.name,"'"));if(null!=e&&0<e.length){var n,r=_createForOfIteratorHelper(e);try{for(r.s();!(n=r.n()).done;){var a=n.value;o.addMessage("warning",o.text("basic.warning"),a,15e3)}}catch(e){r.e(e)}finally{r.f()}}else{for(var s=0;s<u.values.length;s++)u.values[s]=u.fields[s].validate();var i=u.values;u.crudTable.crud.getData().values.push(i),u.crudTable.addCrudLine(new CrudEditLine(i,u.crudTable)),u.initData(u.values.length);for(var l=0;l<u.values.length;l++)u.fields[l].value=u.values[l],u.fields[l].update();u.crudTable.updateLineNumbers()}},e.getElementsByClassName("crudjs-add-cancel-btn")[0].onclick=function(){var e,t=_createForOfIteratorHelper(u.fields);try{for(t.s();!(e=t.n()).done;){var n=e.value;n.value=n.defaultValue,n.update()}}catch(e){t.e(e)}finally{t.f()}u.crudTable.updateLineNumbers()},this.element.appendChild(e)}}]),a}(),CrudTable=function(){function t(e){_classCallCheck(this,t),this.crud=e,this.element=createElement('<div class="table-responsive"></div>'),this.element.innerHTML='\n        <table class="table">\n          <thead class="thead-light">\n          </thead>\n          <tbody>\n          </tbody>\n        </table>\n        ',this.thead=this.element.getElementsByTagName("thead")[0],this.tbody=this.element.getElementsByTagName("tbody")[0],this.modalDeleteId="crudjs-modal-"+ ++t.ID,this.modalDelete=this.createModal()}return _createClass(t,[{key:"render",value:function(){this.resetTable(),this.renderHead(),this.renderLines(),this.updateLineNumbers()}},{key:"resetTable",value:function(){resetElementHTML(this.thead),resetElementHTML(this.tbody)}},{key:"renderHead",value:function(){this.thead.innerHTML='<tr><th scope="col"><strong>#</strong></th></tr>';var e,t=_createForOfIteratorHelper(this.crud.getData().columns);try{for(t.s();!(e=t.n()).done;){var n=e.value,r=document.createElement("th");r.setAttribute("scope","col"),r.innerHTML="<strong>"+n.name+"</strong>",this.thead.children[0].appendChild(r)}}catch(e){t.e(e)}finally{t.f()}if(this.crud.isEditable()){var a=document.createElement("th");a.setAttribute("scope","col"),a.className="text-right pr-3",a.innerHTML="<strong>".concat(this.crud.text("table.column.actionName"),"</strong>"),this.thead.children[0].appendChild(a)}}},{key:"renderLines",value:function(){this.getCrud().isEditable()&&this.addCrudLine(new CrudAddLine(this));for(var e=this.crud.getData().values,t=0;t<e.length;t++)this.addCrudLine(new CrudEditLine(e[t],this))}},{key:"addCrudLine",value:function(e){this.tbody.appendChild(e.getElement())}},{key:"updateLineNumbers",value:function(){var e,t=1,n=_createForOfIteratorHelper(this.element.getElementsByClassName("crudjs-line-number"));try{for(n.s();!(e=n.n()).done;){var r=e.value;isHidden(r.parentNode)||(r.textContent=t++)}}catch(e){n.e(e)}finally{n.f()}}},{key:"disableButtons",value:function(){var e,t=_createForOfIteratorHelper(this.element.getElementsByClassName("crudjs-edit-btn"));try{for(t.s();!(e=t.n()).done;){e.value.disabled=!0}}catch(e){t.e(e)}finally{t.f()}var n,r=_createForOfIteratorHelper(this.element.getElementsByClassName("crudjs-delete-btn"));try{for(r.s();!(n=r.n()).done;){n.value.disabled=!0}}catch(e){r.e(e)}finally{r.f()}var a,s=_createForOfIteratorHelper(this.element.getElementsByClassName("crudjs-add-btn"));try{for(s.s();!(a=s.n()).done;){a.value.disabled=!0}}catch(e){s.e(e)}finally{s.f()}var i,l=_createForOfIteratorHelper(this.element.getElementsByClassName("crudjs-add-cancel-btn"));try{for(l.s();!(i=l.n()).done;){i.value.disabled=!0}}catch(e){l.e(e)}finally{l.f()}}},{key:"enableButtons",value:function(){var e,t=_createForOfIteratorHelper(this.element.getElementsByClassName("crudjs-edit-btn"));try{for(t.s();!(e=t.n()).done;){e.value.disabled=!1}}catch(e){t.e(e)}finally{t.f()}var n,r=_createForOfIteratorHelper(this.element.getElementsByClassName("crudjs-delete-btn"));try{for(r.s();!(n=r.n()).done;){n.value.disabled=!1}}catch(e){r.e(e)}finally{r.f()}var a,s=_createForOfIteratorHelper(this.element.getElementsByClassName("crudjs-add-btn"));try{for(s.s();!(a=s.n()).done;){a.value.disabled=!1}}catch(e){s.e(e)}finally{s.f()}var i,l=_createForOfIteratorHelper(this.element.getElementsByClassName("crudjs-add-cancel-btn"));try{for(l.s();!(i=l.n()).done;){i.value.disabled=!1}}catch(e){l.e(e)}finally{l.f()}}},{key:"createModal",value:function(){var e=createElement('\n        <div class="modal fade" id="'+this.modalDeleteId+'" tabindex="-1" role="dialog" aria-hidden="true">\n          <div class="modal-dialog" role="document">\n            <div class="modal-content">\n              <div class="modal-header">\n                <h5 class="modal-title">'.concat(this.crud.text("table.modal.delete.title"),'</h5>\n                <button type="button" class="close" data-dismiss="modal" aria-label="Close">\n                  <span aria-hidden="true">&times;</span>\n                </button>\n              </div>\n              <div class="modal-body">\n                ').concat(this.crud.text("table.modal.delete.message"),'\n              </div>\n              <div class="modal-footer">\n                <button type="button" class="btn btn-secondary mr-1" data-dismiss="modal">').concat(this.crud.text("basic.no"),'</button>\n                <button type="button" class="btn btn-raised btn-info crudjs-modal-valid" data-dismiss="modal">').concat(this.crud.text("basic.yes"),"</button>\n              </div>\n            </div>\n          </div>\n        </div>\n        "));return document.body.appendChild(e),e}},{key:"getElement",value:function(){return this.element}},{key:"getModalDelete",value:function(){return this.modalDelete}},{key:"getModalDeleteId",value:function(){return this.modalDeleteId}},{key:"getCrud",value:function(){return this.crud}}]),t}();CrudTable.ID=0;var CrudRequest=function(){function r(e,t,n){_classCallCheck(this,r),this.crud=e,this.url=t,this.addMessageFunc=n}return _createClass(r,[{key:"get",value:function(t,n){fetch(this.url,{method:"GET"}).then(function(e){return e.json()}).then(function(e){e.values.forEach(function(e){e.oldValue=_toConsumableArray(e),e.status="S"}),t(e)}).catch(function(e){n(e)})}},{key:"send",value:function(t){var n=[],r=[],a=[],s=[];this.noError=!0;var i=this;t.forEach(function(e){switch(e.status){case"N":n.push(e);break;case"M":r.push(e.oldValue),a.push(e);break;case"D":s.push(e.oldValue)}});var e={"Content-Type":"application/json"};"undefined"!=typeof CSRF&&null!==CSRF&&(e["X-CSRFToken"]=CSRF),fetch(i.url,{method:"POST",headers:e,body:JSON.stringify({actions:[{request:"NEW",new_values:n},{request:"MODIFIED",old_values:r,new_values:a},{request:"DELETED",old_values:s}]})}).then(function(e){return e.json()}).then(function(e){e.actions.forEach(function(e){"result"in e?i.handle(e,t):(i.noError=!1,i.addMessageFunc("danger",i.crud.text("basic.error"),i.crud.text("request.badResponse"),5e3))}),i.noError&&i.addMessageFunc("success",i.crud.text("basic.ok"),i.crud.text("request.okResponse"),5e3)}).catch(function(e){console.error(e)})}},{key:"handle",value:function(r,a){var s=this;switch(r.request){case"NEW":r.result.forEach(function(e,t){if("ERROR"===e[0])s.addMessageFunc("warning",s.crud.text("basic.error"),"".concat(s.crud.text("request.addImpossible")," '").concat(r.new_values[t].join(", "),"' − ").concat(e[1]),2e4),s.noError=!1;else{var n=a.find(function(e){return e.join("&")===r.new_values[t].join("&")});n.status="S",n.oldValue=r.new_values[t]}});break;case"MODIFIED":r.result.forEach(function(e,t){if("ERROR"===e[0])s.addMessageFunc("warning",s.crud.text("basic.error"),"".concat(s.crud.text("request.modifyImpossible")," '").concat(r.new_values[t].join(", "),"' − ").concat(e[1]),2e4),s.noError=!1;else{var n=a.find(function(e){return e.join("&")===r.new_values[t].join("&")});n.status="S",n.oldValue=r.new_values[t]}});break;case"DELETED":var i=[];r.result.forEach(function(e,t){if("ERROR"===e[0])s.addMessageFunc("warning",s.crud.text("basic.error"),"".concat(s.crud.text("request.deleteImpossible")," '").concat(r.new_values[t].join(", "),"' − ").concat(e[1]),2e4),s.noError=!1;else{var n=a.findIndex(function(e){return e.oldValue.join("&")===r.old_values[t].join("&")});i.push(n)}});for(var e=i.length-1;0<=e;--e)a.splice(i[e],1)}}}]),r}(),CrudComponent=function(){_inherits(n,_wrapNativeSuper(HTMLElement));var t=_createSuper(n);function n(){var e;return _classCallCheck(this,n),(e=t.call(this)).init(),e}return _createClass(n,null,[{key:"observedAttributes",get:function(){return["lang","url","save-button"]}}]),_createClass(n,[{key:"init",value:function(){this.attr={};var e=!0,t=this.getAttribute("lang"),n=this.getAttribute("url"),r=this.getAttribute("save-button");if(this.resetDisplay(),null!=t){var a=t.slice(0,2);langExist(a)?(this.setAttr("langOrigin","ATTRIBUTE"),this.setAttr("lang",a)):e=!1}else if(null!=document.documentElement.lang&&2<=document.documentElement.lang.length){var s=document.documentElement.lang.slice(0,2);langExist(s)?(this.setAttr("langOrigin","PAGE"),this.setAttr("lang",s)):e=!1}else if(window.navigator){var i=null!=window.navigator.language&&2<=window.navigator.language.length?window.navigator.language.slice(0,2):null!=window.navigator.userLanguage&&2<=window.navigator.userLanguage.length?window.navigator.userLanguage.slice(0,2):null;null!=i&&langExist(i)?(this.setAttr("langOrigin","NAVIGATOR"),this.setAttr("lang",i)):(this.setAttr("langOrigin","DEFAULT"),this.setAttr("lang",DEFAULT_LANG))}else this.setAttr("langOrigin","DEFAULT"),this.setAttr("lang",DEFAULT_LANG);if(null!=n&&e?this.setAttr("url",n):e=!1,null!=r&&e){var l=document.getElementById(r);null!=l?this.setAttr("saveButton",l):e=!1}if(this.setAttr("loadElement",createElement('<h1 class="text-info"><i class="fas fa-spinner fa-pulse"></i></h1>')),this.setAttr("errorElement",createElement('\n            <div class="alert alert-warning" role="alert">\n                <strong><span class="crudjs-error-t">'.concat(this.text("basic.error").toUpperCase(),'</span>:</strong>\n                <span class="crudjs-error-m">Unknown</span>\n            </div>\n            '))),this.setAttr("messagesElement",createElement('<div style="position:fixed;right:10px;bottom:10px;z-index:100;pointer-events:none"></div>')),e){if(this.setAttr("data",null),this.setAttr("request",new CrudRequest(this,this.getUrl(),this.getAddMessageWrapper())),this.setAttr("table",new CrudTable(this)),document.body.appendChild(this.getAttr("messagesElement")),this.isEditable()){var o=this;this.getAttr("saveButton").onclick=function(){o.save()}}this.load()}else this.displayError(this.text("basic.error"),this.text("component.configurationError"))}},{key:"load",value:function(){this.displayLoading(),this.getAttr("request").get(this.getDataLoadedWrapper(),this.getWrongUrlWrapper())}},{key:"wrongUrl",value:function(e){this.displayError(this.text("basic.error"),"".concat(this.text("component.urlError")," ").concat(e))}},{key:"dataLoaded",value:function(e){this.setAttr("data",e),this.displayTable()}},{key:"save",value:function(){this.getData()&&this.getAttr("request").send(this.getValues())}},{key:"text",value:function(e){return _text(this.getLang(),e)}},{key:"addMessage",value:function(e,t,n,r){null==r&&(r=6e4);var a=createElement('\n            <div style="box-shadow:2px 2px 7px black;display:inline-block;float:right;clear:right;pointer-events:auto;" class="alert alert-'+e+' alert-dismissible fade show" role="alert">\n              <strong>'+t+":</strong> "+n+'\n              <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n            </div>\n        ');this.getAttr("messagesElement").appendChild(a),setTimeout(function(){null!=a.parentNode&&a.getElementsByClassName("close")[0].click()},r)}},{key:"resetDisplay",value:function(){resetElementHTML(this)}},{key:"displayLoading",value:function(){this.setChild(this.getAttr("loadElement"))}},{key:"displayError",value:function(e,t){var n,r=this.getAttr("errorElement"),a=_createForOfIteratorHelper(r.getElementsByClassName("crudjs-error-t"));try{for(a.s();!(n=a.n()).done;){n.value.textContent=e}}catch(e){a.e(e)}finally{a.f()}var s,i=_createForOfIteratorHelper(r.getElementsByClassName("crudjs-error-m"));try{for(i.s();!(s=i.n()).done;){s.value.textContent=t}}catch(e){i.e(e)}finally{i.f()}this.setChild(r)}},{key:"displayTable",value:function(){var e=this.getAttr("table");e.render(),this.setChild(e.getElement())}},{key:"connectedCallback",value:function(){}},{key:"disconnectedCallback",value:function(){}},{key:"adoptedCallback",value:function(){}},{key:"attributeChangedCallback",value:function(e,t,n){this.getData()&&n&&this.init()}},{key:"setAttr",value:function(e,t){this.attr[e]=t}},{key:"getAttr",value:function(e){return this.attr[e]}},{key:"getData",value:function(){return this.getAttr("data")}},{key:"getValues",value:function(){return this.getData().values}},{key:"getLang",value:function(){return this.getAttr("lang")}},{key:"getUrl",value:function(){return this.getAttr("url")}},{key:"isEditable",value:function(){return null!=this.getAttr("saveButton")}},{key:"setChild",value:function(e){this.resetDisplay(),this.appendChild(e)}},{key:"getAddMessageWrapper",value:function(){var a=this;return function(e,t,n,r){a.addMessage(e,t,n,r)}}},{key:"getDataLoadedWrapper",value:function(){var t=this;return function(e){t.dataLoaded(e)}}},{key:"getWrongUrlWrapper",value:function(){var t=this;return function(e){t.wrongUrl(e)}}}]),n}();customElements.define("crud-js",CrudComponent);
